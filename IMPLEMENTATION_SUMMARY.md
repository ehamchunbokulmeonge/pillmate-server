# μ•½ μ¤μΊ” λ¶„μ„ κΈ°λ¥ κµ¬ν„ μ™„λ£

## κµ¬ν„ λ‚΄μ©

### 1. μƒλ΅μ΄ API μ—”λ“ν¬μΈνΈ

**POST /api/v1/analysis/scan**

μ•½ ν¨ν‚¤μ§€λ¥Ό μ΄¬μν•λ©΄ OCRλ΅ μΈμ‹ν•κ³ , μ‚¬μ©μμ ν„μ¬ λ³µμ© μ¤‘μΈ μ•½λ¬Όκ³Ό λΉ„κµν•μ—¬ μ„ν—μ„±μ„ AIλ΅ λ¶„μ„ν•©λ‹λ‹¤.

### 2. κΈ°λ¥ ν”λ΅μ°

```
1. μ‚¬μ©μκ°€ μ•½ ν¨ν‚¤μ§€ μ‚¬μ§„ μ΄¬μ
   β†“
2. Base64λ΅ μΈμ½”λ”©ν•μ—¬ API μ „μ†΅
   β†“
3. Google Cloud Vision APIλ΅ OCR μ²λ¦¬
   β†“
4. AI Hub λ°μ΄ν„°μ…‹(8,024κ°)μ—μ„ Fuzzy MatchingμΌλ΅ μ•½λ¬Ό κ²€μƒ‰
   β†“
5. μ‚¬μ©μμ ν„μ¬ λ³µμ© μ•½λ¬Ό DB μ΅°ν
   β†“
6. OpenAI GPT-4o-miniλ΅ μ„ν—μ„± λ¶„μ„
   - μ„±λ¶„ μ¤‘λ³µ (duplicate)
   - μ•½λ¬Ό μƒνΈμ‘μ© (interaction)
   - λ³µμ© μ‹κ°„ μ¶©λ (timing)
   β†“
7. μ„ν—λ„ μ μ(0-10), μ„ν— λ“±κΈ‰, μƒμ„Έ ν•­λ©, κ²½κ³  λ©”μ‹μ§€ λ°ν™
```

### 3. μ‘λ‹µ μμ‹

```json
{
  "scannedMedication": {
    "name": "νƒ€μ΄λ λ†€μ • 500mg",
    "ingredient": "μ•„μ„ΈνΈμ•„λ―Έλ…Έν",
    "amount": "500mg"
  },
  "overallRiskScore": 7,
  "riskLevel": "medium",
  "riskItems": [
    {
      "id": "duplicate-1",
      "type": "duplicate",
      "severity": "high",
      "title": "μ„±λ¶„ μ¤‘λ³µ κ°μ§€",
      "description": "μ•„μ„ΈνΈμ•„λ―Έλ…Έν μ„±λ¶„μ΄ κ²λ³΄λ¦°μ •κ³Ό μ¤‘λ³µλ©λ‹λ‹¤.",
      "percentage": 85
    }
  ],
  "warnings": [
    "μ•„μ„ΈνΈμ•„λ―Έλ…Έν μ„±λ¶„μ΄ μ¤‘λ³µλ©λ‹λ‹¤. κ³Όλ‹¤ λ³µμ©μ— μ£Όμν•μ„Έμ”."
  ]
}
```

### 4. μμ •λ νμΌ

#### app/routes/analysis.py
- **μ¶”κ°€λ ν•¨μ**:
  - `analyze_with_ai()`: OpenAIλ¥Ό μ‚¬μ©ν• μ•½λ¬Ό μƒνΈμ‘μ© λ¶„μ„
  - `analyze_scanned_medication()`: μ•½ μ¤μΊ” λ¶„μ„ λ©”μΈ μ—”λ“ν¬μΈνΈ

- **μ£Όμ” λ΅μ§**:
  1. OCR ν…μ¤νΈ μ¶”μ¶ (`extract_text_from_image`)
  2. AI Hub λ°μ΄ν„°μ…‹ κ²€μƒ‰ (`search_medicine_in_aihub_data`)
  3. μ‚¬μ©μ μ•½λ¬Ό λ©λ΅ μ΅°ν (DB)
  4. OpenAI λ¶„μ„ (μ„±λ¶„ μ¤‘λ³µ, μƒνΈμ‘μ©, μ‹κ°„ μ¶©λ)
  5. κµ¬μ΅°ν™”λ JSON μ‘λ‹µ λ°ν™

#### app/schemas/analysis.py
- **μ¶”κ°€λ μ¤ν‚¤λ§** (μ΄λ―Έ μ΅΄μ¬ν–μ):
  - `ScannedMedication`: μ΄¬μν• μ•½λ¬Ό μ •λ³΄
  - `RiskItem`: μ„ν— ν•­λ© (type, severity, title, description, percentage)
  - `MedicationAnalysisResponse`: λ¶„μ„ μ‘λ‹µ
  - `ScanAnalysisRequest`: μ¤μΊ” λ¶„μ„ μ”μ²­

### 5. AI λ¶„μ„ ν”„λ΅¬ν”„νΈ

OpenAI GPT-4o-miniμ— λ‹¤μ μ‘μ—… μ§€μ‹:

```
1. μ΄¬μν• μ•½λ¬Όμ μ„±λ¶„κ³Ό μ‚¬μ©μμ ν„μ¬ λ³µμ© μ•½λ¬Ό λΉ„κµ
2. 3κ°€μ§€ μ„ν— μ ν• λ¶„μ„:
   - duplicate: μ„±λ¶„ μ¤‘λ³µ
   - interaction: μ•½λ¬Ό μƒνΈμ‘μ©
   - timing: λ³µμ© μ‹κ°„ μ¶©λ
3. JSON ν•μ‹μΌλ΅ κµ¬μ΅°ν™”λ μ‘λ‹µ λ°ν™
   - overallRiskScore (0-10)
   - riskLevel (low/medium/high)
   - riskItems λ°°μ—΄ (κ° μ„ν— ν•­λ© μƒμ„Έ)
   - warnings λ°°μ—΄ (κ²½κ³  λ©”μ‹μ§€)
```

### 6. ν…μ¤νΈ μ¤ν¬λ¦½νΈ

**test_scan_analysis.py** μƒμ„±
- μ΄λ―Έμ§€λ¥Ό Base64λ΅ μΈμ½”λ”©
- API νΈμ¶ λ° μ‘λ‹µ μ¶λ ¥
- ν…μ¤νΈμ© μ•½λ¬Ό μ¶”κ°€ μµμ…

```bash
# μ‚¬μ©λ²•
python test_scan_analysis.py νƒ€μ΄λ°μ •.jpg
python test_scan_analysis.py νƒ€μ΄λ λ†€.jpeg --add-test-med
```

### 7. λ¬Έμ„ν™”

**docs/SCAN_ANALYSIS_API.md** μƒμ„±
- API μ—”λ“ν¬μΈνΈ μƒμ„Έ μ„¤λ…
- μ”μ²­/μ‘λ‹µ μ¤ν‚¤λ§
- Python, cURL μ‚¬μ© μμ‹
- λ¶„μ„ λ΅μ§ μ„¤λ…
- μ—λ¬ μ²λ¦¬ κ°€μ΄λ“

### 8. κΈ°μ  μ¤νƒ ν™μ©

| κΈ°μ  | μ©λ„ |
|------|------|
| Google Cloud Vision API | OCR ν…μ¤νΈ μ¶”μ¶ |
| AI Hub λ°μ΄ν„°μ…‹ | 8,024κ° μ•½λ¬Ό μ •λ³΄ λ§¤μΉ­ |
| rapidfuzz | Fuzzy string matching (80% μ μ‚¬λ„) |
| OpenAI GPT-4o-mini | μ•½λ¬Ό μƒνΈμ‘μ© AI λ¶„μ„ |
| FastAPI | REST API μ—”λ“ν¬μΈνΈ |
| PostgreSQL | μ‚¬μ©μ μ•½λ¬Ό λ°μ΄ν„° μ €μ¥ |

## κ²€μ¦ μ™„λ£

### β… μ„λ²„ μ‹μ‘ μ„±κ³µ
```
INFO:     Application startup complete.
```

### β… μ—”λ“ν¬μΈνΈ λ“±λ΅ ν™•μΈ
```
/api/v1/analysis/scan (POST)
```

### β… μ—λ¬ μ—†μ
```python
get_errors("/Users/tlsalsco/pillmate/app/routes/analysis.py")
# No errors found
```

## λ‹¤μ λ‹¨κ³„

### 1. μ‹¤μ  μ΄λ―Έμ§€λ΅ ν…μ¤νΈ
```bash
# μ•½ ν¨ν‚¤μ§€ μ‚¬μ§„μ„ μ°μ–΄μ„ ν…μ¤νΈ
python test_scan_analysis.py <μ΄λ―Έμ§€_νμΌ>
```

### 2. κ³µκ° μ ‘κ·Ό (ngrok)
```bash
# ν„μ¬ μ„λ²„: localhost:8000
# ngrokμΌλ΅ κ³µκ° URL μƒμ„±ν•μ—¬ μ–΄λ””μ„λ“  μ ‘κ·Ό κ°€λ¥
```

### 3. ν”„λ΅ νΈμ—”λ“ μ—°λ™
- μΉ΄λ©”λΌ κΈ°λ¥μΌλ΅ μ•½ μ΄¬μ
- Base64 μΈμ½”λ”© ν›„ API μ „μ†΅
- λ¶„μ„ κ²°κ³Όλ¥Ό μ‚¬μ©μ μΉν™”μ μΌλ΅ ν‘μ‹

## μ‚¬μ© μ‹λ‚λ¦¬μ¤

### μ‹λ‚λ¦¬μ¤ 1: μ„±λ¶„ μ¤‘λ³µ κ°μ§€
```
1. μ‚¬μ©μκ°€ νƒ€μ΄λ λ†€ λ³µμ© μ¤‘
2. κ²λ³΄λ¦° ν¨ν‚¤μ§€ μ΄¬μ
3. AI λ¶„μ„ β†’ "μ•„μ„ΈνΈμ•„λ―Έλ…Έν μ„±λ¶„ μ¤‘λ³µ" κ²½κ³ 
4. κ³Όλ‹¤ λ³µμ© λ°©μ§€
```

### μ‹λ‚λ¦¬μ¤ 2: μ•½λ¬Ό μƒνΈμ‘μ©
```
1. μ‚¬μ©μκ°€ μ•„μ¤ν”Όλ¦° λ³µμ© μ¤‘
2. μ΄λ¶€ν”„λ΅ν ν¨ν‚¤μ§€ μ΄¬μ
3. AI λ¶„μ„ β†’ "μ„μ¥ μ¶ν μ„ν—" κ²½κ³ 
4. μ•μ „ν• μ•½λ¬Ό μ„ νƒ μ λ„
```

### μ‹λ‚λ¦¬μ¤ 3: λ³µμ© μ‹κ°„ μ¶©λ
```
1. μ‚¬μ©μκ°€ μ•„μΉ¨ 8μ‹μ— 5κ° μ•½λ¬Ό λ³µμ© μ¤‘
2. μƒλ΅μ΄ μ•½ ν¨ν‚¤μ§€ μ΄¬μ
3. AI λ¶„μ„ β†’ "μ•„μΉ¨ μ‹κ°„λ€ μ•½λ¬Ό κ³Όλ‹¤" κ²½κ³ 
4. λ³µμ© μ‹κ°„ λ¶„μ‚° κ¶μ¥
```

## ν•µμ‹¬ κ°€μΉ

1. **μ•μ „μ„±**: AIκ°€ μ•½λ¬Ό μ„ν—μ„±μ„ μ‚¬μ „μ— κ°μ§€
2. **νΈμμ„±**: μ‚¬μ§„ ν• μ¥μΌλ΅ μ¦‰μ‹ λ¶„μ„
3. **μ •ν™•μ„±**: 8,024κ° μ•½λ¬Ό λ°μ΄ν„°μ…‹ + GPT-4o-mini
4. **μ‹¤μ©μ„±**: μ‹¤μ  λ³µμ© μ¤‘μΈ μ•½λ¬Όκ³Ό λΉ„κµν•μ—¬ κ°μΈν™”λ λ¶„μ„

## μ”μ•½

β¨ **μ•½ μ¤μΊ” λ¶„μ„ API κµ¬ν„ μ™„λ£!**

- OCR + AI Hub λ°μ΄ν„°μ…‹μΌλ΅ μ•½λ¬Ό μΈμ‹
- OpenAIλ΅ μ„±λ¶„ μ¤‘λ³µ/μƒνΈμ‘μ©/μ‹κ°„ μ¶©λ λ¶„μ„
- κµ¬μ΅°ν™”λ JSON μ‘λ‹µ (μ„ν—λ„ μ μ, λ“±κΈ‰, μƒμ„Έ ν•­λ©)
- ν…μ¤νΈ μ¤ν¬λ¦½νΈ λ° λ¬Έμ„ν™” μ™„λ£
- μ„λ²„ μ •μƒ λ™μ‘ κ²€μ¦ μ™„λ£

π‘‰ μ΄μ  μ‹¤μ  μ•½ ν¨ν‚¤μ§€ μ΄λ―Έμ§€λ΅ ν…μ¤νΈν•λ©΄ λ©λ‹λ‹¤!
